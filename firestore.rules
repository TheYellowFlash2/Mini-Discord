rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function signedIn() {
      return request.auth != null;
    }
    function isServerMember(serverId) {
      return signedIn() &&
        exists(/databases/$(database)/documents/servers/$(serverId)/members/$(request.auth.uid));
    }
    function isServerOwner(serverId) {
      return signedIn() &&
        exists(/databases/$(database)/documents/servers/$(serverId)) &&
        get(/databases/$(database)/documents/servers/$(serverId)).data.ownerId == request.auth.uid;
    }
    function isServerAdmin(serverId) {
      return isServerOwner(serverId) ||
        (exists(/databases/$(database)/documents/servers/$(serverId)/members/$(request.auth.uid)) && 
         get(/databases/$(database)/documents/servers/$(serverId)/members/$(request.auth.uid)).data.role in ['owner', 'admin']);
    }

    match /users/{userId} {
      allow read: if signedIn();
      allow create: if signedIn() && request.auth.uid == userId;
      allow update, delete: if signedIn() && request.auth.uid == userId;
    }

    match /servers/{serverId} {
      allow read: if signedIn();
      allow create: if signedIn() &&
        (request.resource.data.ownerId == request.auth.uid ||
         (serverId == 'public' && request.resource.data.ownerId == 'system'));
      allow update, delete: if signedIn() && resource.data.ownerId == request.auth.uid;
    }

    match /servers/{serverId}/members/{memberId} {
      allow read: if signedIn() && (isServerMember(serverId) || memberId == request.auth.uid || isServerAdmin(serverId));
      allow create: if signedIn() && (memberId == request.auth.uid || isServerAdmin(serverId));
      allow update, delete: if signedIn() && (isServerAdmin(serverId) || request.auth.uid == memberId);
    }

    match /servers/{serverId}/banned/{userId} {
      allow read: if signedIn() && (isServerAdmin(serverId) || request.auth.uid == userId);
      allow create, delete: if signedIn() && isServerAdmin(serverId);
    }

    match /memberships/{id} {
      allow read: if signedIn() &&
        (resource.data.userId == request.auth.uid ||
         isServerMember(resource.data.serverId) ||
         isServerAdmin(resource.data.serverId));
      allow create: if signedIn() &&
        (request.resource.data.userId == request.auth.uid ||
         isServerAdmin(request.resource.data.serverId));
      allow update: if signedIn() && isServerAdmin(resource.data.serverId);
      allow delete: if signedIn() &&
        (resource.data.userId == request.auth.uid ||
         isServerAdmin(resource.data.serverId));
    }

    match /channels/{channelId} {
      allow read: if signedIn() && isServerMember(resource.data.serverId);
      allow create: if signedIn() &&
        (isServerAdmin(request.resource.data.serverId) || request.resource.data.serverId == 'public');
      allow update, delete: if signedIn() && isServerAdmin(resource.data.serverId);
    }

    match /messages/{messageId} {
      allow read: if signedIn() && isServerMember(resource.data.serverId);
      allow create: if signedIn() &&
        isServerMember(request.resource.data.serverId) &&
        (request.resource.data.userId == request.auth.uid ||
         (isServerAdmin(request.resource.data.serverId) &&
          request.resource.data.userId == 'global-bot-mistral'));
      allow update, delete: if signedIn() &&
        isServerMember(resource.data.serverId) &&
        (resource.data.userId == request.auth.uid || isServerAdmin(resource.data.serverId));
    }

    match /invites/{inviteId} {
      allow read: if signedIn();
      allow create: if signedIn() && isServerAdmin(request.resource.data.serverId);
      allow update: if signedIn() && (
        isServerAdmin(resource.data.serverId) ||
        (
          request.resource.data.serverId == resource.data.serverId &&
          request.resource.data.code == resource.data.code &&
          request.resource.data.createdBy == resource.data.createdBy &&
          request.resource.data.maxUses == resource.data.maxUses &&
          request.resource.data.expireAt == resource.data.expireAt &&
          request.resource.data.uses is int &&
          resource.data.uses is int &&
          request.resource.data.uses == resource.data.uses + 1
        )
      );
      allow delete: if signedIn() && isServerAdmin(resource.data.serverId);
    }

    match /channels/{channelId}/typing/{typingId} {
      allow read: if signedIn() &&
        exists(/databases/$(database)/documents/channels/$(channelId)) &&
        isServerMember(get(/databases/$(database)/documents/channels/$(channelId)).data.serverId);
      allow create, update: if signedIn() &&
        typingId == request.auth.uid &&
        exists(/databases/$(database)/documents/channels/$(channelId)) &&
        isServerMember(get(/databases/$(database)/documents/channels/$(channelId)).data.serverId);
      allow delete: if signedIn() &&
        typingId == request.auth.uid &&
        exists(/databases/$(database)/documents/channels/$(channelId)) &&
        isServerMember(get(/databases/$(database)/documents/channels/$(channelId)).data.serverId);
    }

    match /servers/{serverId}/emojis/{emojiId} {
      allow read: if signedIn() && isServerMember(serverId);
      allow write: if signedIn() && isServerAdmin(serverId);
    }

    match /reports/{reportId} {
      allow read: if signedIn() && isServerAdmin(resource.data.serverId);
      allow create: if signedIn() &&
        isServerMember(request.resource.data.serverId) &&
        request.resource.data.reportedBy == request.auth.uid &&
        request.resource.data.status == 'open';
      allow update: if signedIn() && isServerAdmin(resource.data.serverId);
      allow delete: if signedIn() && isServerAdmin(resource.data.serverId);
    }
  }
}
